name: "aws-datadog-logs-archive"
# Canonical GitHub repo
github_repo: "cloudposse-terraform-components/aws-datadog-logs-archive"
# Short description of this project
description: |-
  This component provisions Datadog Log Archives. It creates a single log archive pipeline for each AWS account. If the `catchall` flag is set, it creates a catchall archive within the same S3 bucket.

  Each log archive filters for the tag `env:$env` where `$env` is the environment/account name (e.g. `sbx`, `prd`, `tools`), as well as any tags identified in the `additional_query_tags` key. The `catchall` archive, as the name implies, filters for `*`.

  A second bucket is created for CloudTrail, and a CloudTrail is configured to monitor the log archive bucket and log activity to the CloudTrail bucket. To forward these CloudTrail logs to Datadog, the CloudTrail bucket's ID must be added to the `s3_buckets` key for our `datadog-lambda-forwarder` component.

  Both buckets support object lock, with overridable defaults of COMPLIANCE mode and a duration of 7 days.

  Prerequisites
  - Datadog integration set up in the target environment
    - Relies on the Datadog API and App keys added by our Datadog integration component

  Issues, Gotchas, Good-to-Knows
  - Destroy/reprovision process
    - Because of the protections for S3 buckets, destroying/replacing the bucket may require two passes or a manual bucket delete followed by Terraform cleanup. If the bucket has a full day or more of logs, deleting it manually first helps avoid Terraform timeouts.
    - Two-step process to destroy via Terraform:
      1) Set `s3_force_destroy` to `true` and apply
      2) Set `enabled` to `false` and apply, or run `terraform destroy`

  ## Sponsorship

  <picture>
    <source media="(prefers-color-scheme: dark)" srcset="https://cloudposse.com/images/partners/datadog-white.svg">
    <source media="(prefers-color-scheme: light)" srcset="https://cloudposse.com/images/partners/datadog-purple.svg">
    <img alt="Datadog" src="https://cloudposse.com/images/partners/datadog-purple.svg" align="right" width="40%">
  </picture>


  This project is supported by the [Datadog Open Source Program](https://www.datadoghq.com/partner/open-source/).

  As part of this collaboration, Datadog provides a dedicated sandbox account that we use for automated integration and acceptance testing. This contribution allows us to continuously validate changes against a real Datadog environment, improving reliability and reducing the risk of regressions.

  We are grateful to Datadog for supporting our open source ecosystem and helping ensure that infrastructure code for Terraform remains stable and well-tested
  ___

usage: |-
  Stack Level: Global

  It's suggested to apply this component to all accounts from which Datadog receives logs.

  Example Atmos snippet:

  ```yaml
  components:
    terraform:
      datadog-logs-archive:
        settings:
          spacelift:
            workspace_enabled: true
        vars:
          enabled: true
      #   additional_query_tags:
      #     - "forwardername:*-dev-datadog-lambda-forwarder-logs"
      #     - "account:123456789012"
  ```
references:
  - name: cloudposse/s3-bucket/aws
    description: "Cloud Posse's S3 component"
    url: https://registry.terraform.io/modules/cloudposse/s3-bucket/aws/latest
  - name: datadog_logs_archive resource
    description: "Datadog's provider documentation for the datadog_logs_archive resource"
    url: https://registry.terraform.io/providers/DataDog/datadog/latest/docs/resources/logs_archive
tags:
  - component/datadog-logs-archive
  - layer/datadog
  - provider/aws
  - provider/datadog
# Categories of this project
categories:
  - component/datadog-logs-archive
  - layer/datadog
  - provider/aws
  - provider/datadog
# License of this project
license: "APACHE2"
# Badges to display
badges:
  - name: Latest Release
    image: https://img.shields.io/github/release/cloudposse-terraform-components/aws-datadog-logs-archive.svg?style=for-the-badge
    url: https://github.com/cloudposse-terraform-components/aws-datadog-logs-archive/releases/latest
  - name: Slack Community
    image: https://slack.cloudposse.com/for-the-badge.svg
    url: https://slack.cloudposse.com
related:
  - name: "Cloud Posse Terraform Modules"
    description: Our collection of reusable Terraform modules used by our reference architectures.
    url: "https://docs.cloudposse.com/modules/"
  - name: "Atmos"
    description: "Atmos is like docker-compose but for your infrastructure"
    url: "https://atmos.tools"
contributors: [] # If included generates contribs
